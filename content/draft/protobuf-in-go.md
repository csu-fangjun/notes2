---
title: "Protobuf in Go"
date: 2018-10-28T16:04:01+08:00
draft: true
tags: [
    "go",
    "golang",
]
categories: [
    "Development",
    "golang",
]
---


### Setup

```sh
go get -u github.com/golang/protobuf/protoc-gen-go
mkdir ~/go/src/hello
mkdir ~/go/src/hello_protobuf
cd ~/go/src/hello_protobuf
touch hello.proto
```

### hello.proto

```proto
syntax = "proto2";
package hello_protobuf;

enum Foo {
    x = 1;
    Y = 2;
};

message Student {
    required int32 id = 1;
    optional int32 age = 2 [default=10];
    optional string name = 3;
    repeated int64 grades = 4;
};
```

Then run
```go
cd ~/go/src/hello_protobuf
protoc --go_out=. hello.proto
```
which generates the file `hello.pb.go`

#### hello.pb.go
Part of the generated file is

```go
// Code generated by protoc-gen-go. DO NOT EDIT.
// source: hello.proto

package hello_protobuf

import (
	fmt "fmt"
	proto "github.com/golang/protobuf/proto"
	math "math"
)

// Reference imports to suppress errors if they are not otherwise used.
var _ = proto.Marshal
var _ = fmt.Errorf
var _ = math.Inf

// This is a compile-time assertion to ensure that this generated file
// is compatible with the proto package it is being compiled against.
// A compilation error at this line likely means your copy of the
// proto package needs to be updated.
const _ = proto.ProtoPackageIsVersion2 // please upgrade the proto package
```

Pay attention to the renaming in the `import` statement.

The `enum` is transformed to

```go
type Foo int32

const (
	Foo_x Foo = 1
	Foo_Y Foo = 2
)

var Foo_name = map[int32]string{
	1: "x",
	2: "Y",
}

var Foo_value = map[string]int32{
	"x": 1,
	"Y": 2,
}

func (x Foo) Enum() *Foo {
	p := new(Foo)
	*p = x
	return p
}

func (x Foo) String() string {
	return proto.EnumName(Foo_name, int32(x))
}

func (x *Foo) UnmarshalJSON(data []byte) error {
	value, err := proto.UnmarshalJSONEnum(Foo_value, data, "Foo")
	if err != nil {
		return err
	}
	*x = Foo(value)
	return nil
}

func (Foo) EnumDescriptor() ([]byte, []int) {
	return fileDescriptor_61ef911816e0a8ce, []int{0}
}
```

The `message` is translated to

```go
type Student struct {
	Id                   *int32   `protobuf:"varint,1,req,name=id" json:"id,omitempty"`
	Age                  *int32   `protobuf:"varint,2,opt,name=age,def=10" json:"age,omitempty"`
	Name                 *string  `protobuf:"bytes,3,opt,name=name" json:"name,omitempty"`
	Grades               []int64  `protobuf:"varint,4,rep,name=grades" json:"grades,omitempty"`
	XXX_NoUnkeyedLiteral struct{} `json:"-"`
	XXX_unrecognized     []byte   `json:"-"`
	XXX_sizecache        int32    `json:"-"`
}

func (m *Student) Reset()         { *m = Student{} }
func (m *Student) String() string { return proto.CompactTextString(m) }
func (*Student) ProtoMessage()    {}
func (*Student) Descriptor() ([]byte, []int) {
	return fileDescriptor_61ef911816e0a8ce, []int{0}
}

// ...


const Default_Student_Age int32 = 10

func (m *Student) GetId() int32 {
	if m != nil && m.Id != nil {
		return *m.Id
	}
	return 0
}

func (m *Student) GetAge() int32 {
	if m != nil && m.Age != nil {
		return *m.Age
	}
	return Default_Student_Age
}

func (m *Student) GetName() string {
	if m != nil && m.Name != nil {
		return *m.Name
	}
	return ""
}

func (m *Student) GetGrades() []int64 {
	if m != nil {
		return m.Grades
	}
	return nil
}

func init() {
	proto.RegisterEnum("hello_protobuf.Foo", Foo_name, Foo_value)
	proto.RegisterType((*Student)(nil), "hello_protobuf.Student")
}

func init() { proto.RegisterFile("hello.proto", fileDescriptor_61ef911816e0a8ce) }

var fileDescriptor_61ef911816e0a8ce = []byte{
    ....
}
```

Note that there are **two** `init()` function!!! See
[Package initialization][1].

### hello.go

```sh
cd ~/go/src/hello
touch hello.go
vim hello.go
```

```go
package main

import (
	"log"

	"fmt"
	"github.com/golang/protobuf/proto"
	"hello_protobuf"
)

func main() {
	s := hello_protobuf.Student{}
	fmt.Println(s) /* {<nil> <nil> <nil> [] {} [] 0} */

	s = hello_protobuf.Student{
		Id:     proto.Int32(1),
		Age:    proto.Int32(22),
		Name:   proto.String("Tom Green"),
		Grades: []int64{80, 100, 99},
	}
	fmt.Println(s) /* {0xc000076040 0xc000076044 0xc000064380 [80 100 99] {} [] 0} */

	data, err := proto.Marshal(&s)
	if err != nil {
		log.Fatal("marshaling error: ", err)
	}
	fmt.Printf("%T %[1]v\n", data) /* []uint8 [8 1 16 22 26 9 84 111 109 32 71 114 101 101 110 32 80 32 100 32 99] */

	s2 := hello_protobuf.Student{}
	err = proto.Unmarshal(data, &s2)
	if err != nil {
		log.Fatal("Unmarshaling error: ", err)
	}
	if s2.GetId() != s.GetId() {
		log.Fatal("id differs:  %d != %d", s2.GetId(), s.GetId())
	}
	fmt.Println(s2) /* {0xc000076108 0xc00007610c 0xc0000643a0 [80 100 99] {} [] 0} */
	/*Note that the unmarshaling process has copy semantics! */
}
```

### References

- [test.proto][2]
- [test.pb.go][3]
- [Protocol Buffer Basics: Go][4]

[4]: https://developers.google.com/protocol-buffers/docs/gotutorial
[3]: https://github.com/golang/protobuf/blob/master/proto/test_proto/test.pb.go
[2]: https://github.com/golang/protobuf/blob/master/proto/test_proto/test.proto
[1]: https://golang.org/ref/spec#Package_initialization
